package com.mapbox.navigation.qa_test_app.view

import android.annotation.SuppressLint
import android.os.Bundle
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import com.mapbox.api.directions.v5.DirectionsCriteria
import com.mapbox.api.directions.v5.models.DirectionsResponse
import com.mapbox.api.directions.v5.models.RouteOptions
import com.mapbox.maps.CameraOptions
import com.mapbox.maps.plugin.locationcomponent.location
import com.mapbox.navigation.base.extensions.applyDefaultNavigationOptions
import com.mapbox.navigation.base.options.NavigationOptions
import com.mapbox.navigation.base.route.NavigationRoute
import com.mapbox.navigation.base.route.RouterOrigin
import com.mapbox.navigation.core.MapboxNavigation
import com.mapbox.navigation.core.directions.session.RoutesObserver
import com.mapbox.navigation.core.lifecycle.MapboxNavigationApp
import com.mapbox.navigation.core.lifecycle.MapboxNavigationObserver
import com.mapbox.navigation.core.lifecycle.requireMapboxNavigation
import com.mapbox.navigation.qa_test_app.R
import com.mapbox.navigation.qa_test_app.databinding.LayoutActivityRouteNotificationsBinding
import com.mapbox.navigation.ui.maps.NavigationStyles
import com.mapbox.navigation.ui.maps.route.line.MapboxRouteLineApiExtensions.setNavigationRoutes
import com.mapbox.navigation.ui.maps.route.line.api.MapboxRouteLineApi
import com.mapbox.navigation.ui.maps.route.line.api.MapboxRouteLineView
import com.mapbox.navigation.ui.maps.route.line.model.MapboxRouteLineOptions
import kotlinx.coroutines.launch

class RouteNotificationsActivity : AppCompatActivity() {

    /**
     * Hardcoded route with a notification in it.
     */
    private val routes = NavigationRoute.create(
        DirectionsResponse.fromJson("""{"routes":[{"weight_typical":37945.098,"duration_typical":1387.588,"weight_name":"auto","weight":37945.098,"duration":1387.588,"distance":15344.898,"legs":[{"via_waypoints":[],"admins":[{"iso_3166_1_alpha3":"BLR","iso_3166_1":"BY"}],"notifications":[{"details":{"requested_value":"paved","actual_value":"compacted","message":"The road has an unpaved surface (compacted)."},"subtype":"unpaved","type":"violation","geometry_index_end":156,"geometry_index_start":132}],"weight_typical":37945.098,"duration_typical":1387.588,"weight":37945.098,"duration":1387.588,"steps":[{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Drive northwest for a half mile.</prosody></amazon:effect></speak>","announcement":"Drive northwest for a half mile.","distanceAlongGeometry":731.748},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Turn right onto <say-as interpret-as=\"address\">Лясная вуліца</say-as>.</prosody></amazon:effect></speak>","announcement":"In a quarter mile, Turn right onto Лясная вуліца.","distanceAlongGeometry":402.336},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Turn right onto <say-as interpret-as=\"address\">Лясная вуліца</say-as>, <say-as interpret-as=\"address\">Лесная улица</say-as>.</prosody></amazon:effect></speak>","announcement":"Turn right onto Лясная вуліца, Лесная улица.","distanceAlongGeometry":66.111}],"intersections":[{"entry":[true],"bearings":[310],"duration":42.188,"mapbox_streets_v8":{"class":"service"},"is_urban":false,"admin_index":0,"out":0,"weight":35.86,"geometry_index":0,"location":[25.652782,53.305675]},{"entry":[true,true,false],"in":2,"bearings":[6,124,200],"duration":32.596,"turn_weight":1.5,"turn_duration":0.052,"mapbox_streets_v8":{"class":"service"},"is_urban":false,"admin_index":0,"out":0,"weight":29.162,"geometry_index":5,"location":[25.652551,53.308007]},{"entry":[true,false,false],"in":2,"bearings":[25,124,205],"duration":18.225,"turn_weight":1,"turn_duration":0.019,"mapbox_streets_v8":{"class":"street"},"is_urban":false,"admin_index":0,"out":0,"weight":16.475,"geometry_index":9,"location":[25.653411,53.309957]},{"bearings":[5,170,205],"entry":[true,true,false],"in":2,"turn_weight":1.5,"turn_duration":0.083,"mapbox_streets_v8":{"class":"street"},"is_urban":false,"admin_index":0,"out":0,"geometry_index":10,"location":[25.654542,53.311394]}],"maneuver":{"type":"depart","instruction":"Drive northwest.","bearing_after":310,"bearing_before":0,"location":[25.652782,53.305675]},"name":"","weight_typical":86.145,"duration_typical":96.795,"duration":96.795,"distance":731.748,"driving_side":"right","weight":86.145,"mode":"driving","geometry":"usotdB{av|o@uU~k@_QvNm\\kCy[aMym@{Zac@wE{k@aQ{a@eWaEwCyxAueA{R_B"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In 700 feet, Turn left onto <say-as interpret-as=\"address\">Лясная вуліца</say-as>.</prosody></amazon:effect></speak>","announcement":"In 700 feet, Turn left onto Лясная вуліца.","distanceAlongGeometry":197.831},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Turn left onto <say-as interpret-as=\"address\">Лясная вуліца</say-as>, <say-as interpret-as=\"address\">Лесная улица</say-as>.</prosody></amazon:effect></speak>","announcement":"Turn left onto Лясная вуліца, Лесная улица.","distanceAlongGeometry":94.444}],"intersections":[{"bearings":[96,185,276,344],"entry":[true,false,true,true],"in":1,"turn_weight":7,"turn_duration":2.315,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"geometry_index":11,"location":[25.65459,53.311712]}],"maneuver":{"type":"turn","instruction":"Turn right onto Лясная вуліца/Лесная улица/Н299.","modifier":"right","bearing_after":96,"bearing_before":5,"location":[25.65459,53.311712]},"name":"Лясная вуліца; Лесная улица","weight_typical":24.698,"duration_typical":23.136,"duration":23.136,"distance":214.498,"driving_side":"right","weight":24.698,"mode":"driving","ref":"Н299","geometry":"_m{tdB{ry|o@jKogE"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Continue on <say-as interpret-as=\"address\">Н299</say-as> for 1.5 miles.</prosody></amazon:effect></speak>","announcement":"Continue on Н299 for 1.5 miles.","distanceAlongGeometry":2225.666},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Keep right to stay on <say-as interpret-as=\"address\">Н299</say-as>.</prosody></amazon:effect></speak>","announcement":"In a quarter mile, Keep right to stay on Н299.","distanceAlongGeometry":402.336},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Keep right to stay on <say-as interpret-as=\"address\">Н299</say-as>.</prosody></amazon:effect></speak>","announcement":"Keep right to stay on Н299.","distanceAlongGeometry":88.889}],"intersections":[{"entry":[true,true,false],"in":2,"bearings":[37,191,276],"duration":55.335,"turn_weight":3.75,"turn_duration":1.407,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":49.589,"geometry_index":12,"location":[25.657798,53.311514]},{"entry":[false,true,false],"in":2,"bearings":[1,86,266],"duration":17.359,"turn_weight":0.75,"turn_duration":0.007,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":15.933,"geometry_index":22,"location":[25.667045,53.313412]},{"entry":[true,true,false],"in":2,"bearings":[41,92,272],"duration":40.039,"turn_weight":0.75,"turn_duration":0.007,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":35.778,"geometry_index":24,"location":[25.670665,53.31352]},{"entry":[true,false,true],"in":1,"bearings":[84,266,353],"duration":47.988,"turn_weight":0.75,"turn_duration":0.021,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":42.722,"geometry_index":29,"location":[25.678951,53.314033]},{"entry":[true,true,false,true],"in":2,"bearings":[8,97,258,284],"duration":17.149,"turn_weight":1.125,"turn_duration":0.025,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":16.109,"geometry_index":39,"location":[25.684632,53.316445]},{"bearings":[21,114,289],"entry":[false,true,false],"in":2,"turn_weight":0.75,"turn_duration":0.01,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"geometry_index":43,"location":[25.687173,53.316023]}],"maneuver":{"type":"turn","instruction":"Turn left onto Лясная вуліца/Лесная улица/Н299. Continue on Н299.","modifier":"left","bearing_after":37,"bearing_before":96,"location":[25.657798,53.311514]},"name":"Лясная вуліца; Лесная улица","weight_typical":163.179,"duration_typical":180.507,"duration":180.507,"distance":2242.333,"driving_side":"right","weight":163.179,"mode":"driving","ref":"Н299","geometry":"s`{tdBk{_}o@sb@}k@uf@mPeRmPaU{i@kCe]~He_@xKsl@XmmAaSklFg@m^qFe|DXad@jAwlBkHuqA{AqX}MybCgFagDoBiy@aG_YuQ_^oUqRsb@s_@sTq[yLe_@mIae@_K{s@oC{b@jB_o@dIiq@tFec@bDiW~DaV"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Continue for a half mile.</prosody></amazon:effect></speak>","announcement":"Continue for a half mile.","distanceAlongGeometry":847.729},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Turn left onto <say-as interpret-as=\"address\">Р108</say-as>.</prosody></amazon:effect></speak>","announcement":"In a quarter mile, Turn left onto Р108.","distanceAlongGeometry":402.336},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Turn left onto <say-as interpret-as=\"address\">Р108</say-as>.</prosody></amazon:effect></speak>","announcement":"Turn left onto Р108.","distanceAlongGeometry":77.778}],"intersections":[{"entry":[true,true,true,false],"in":3,"bearings":[15,99,123,294],"duration":5.266,"turn_weight":0.75,"turn_duration":0.012,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":2,"weight":5.347,"geometry_index":44,"location":[25.687542,53.315927]},{"entry":[true,true,false],"in":2,"bearings":[25,126,303],"duration":3.511,"turn_weight":0.75,"turn_duration":0.008,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":3.815,"geometry_index":45,"location":[25.688218,53.315662]},{"entry":[true,false,true],"in":1,"bearings":[125,306,331],"duration":10.819,"turn_weight":0.75,"turn_duration":0.019,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":10.2,"geometry_index":46,"location":[25.688653,53.315476]},{"entry":[true,false,false],"in":2,"bearings":[134,265,314],"duration":2.926,"turn_weight":0.75,"turn_duration":0.007,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":3.304,"geometry_index":48,"location":[25.689938,53.31484]},{"entry":[true,true,false],"in":2,"bearings":[110,146,314],"duration":6.632,"turn_weight":1.125,"turn_duration":0.113,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":6.829,"geometry_index":49,"location":[25.690266,53.314652]},{"entry":[true,true,true,false],"in":3,"bearings":[18,103,213,290],"duration":11.414,"turn_weight":1.5,"turn_duration":0.03,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":11.461,"geometry_index":50,"location":[25.691211,53.314446]},{"entry":[true,true,false],"in":2,"bearings":[96,206,283],"duration":5.479,"turn_weight":0.75,"turn_duration":0.03,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":5.518,"geometry_index":52,"location":[25.692929,53.314213]},{"entry":[true,false,false],"in":2,"bearings":[96,246,282],"duration":12.093,"turn_weight":0.75,"turn_duration":0.028,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":11.307,"geometry_index":54,"location":[25.693756,53.314137]},{"entry":[true,true,false],"in":2,"bearings":[34,106,281],"duration":5.944,"turn_weight":0.75,"turn_duration":0.009,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":5.943,"geometry_index":56,"location":[25.69561,53.313992]},{"entry":[true,false,true],"in":1,"bearings":[124,286,310],"duration":0.704,"turn_weight":1.125,"turn_duration":0.023,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":1.721,"geometry_index":57,"location":[25.69649,53.313844]},{"entry":[false,true,false],"in":2,"bearings":[38,125,304],"duration":13.337,"turn_weight":0.75,"turn_duration":0.007,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":12.414,"geometry_index":58,"location":[25.69658,53.313808]},{"entry":[true,true,false],"in":2,"bearings":[37,123,305],"duration":4.792,"turn_weight":0.75,"turn_duration":0.024,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":4.922,"geometry_index":59,"location":[25.698278,53.313106]},{"bearings":[80,211,303],"entry":[true,true,false],"turn_weight":1.125,"turn_duration":0.469,"in":2,"yield_sign":true,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"geometry_index":61,"location":[25.698904,53.312866]}],"maneuver":{"type":"fork","instruction":"Keep right to stay on Н299.","modifier":"slight right","bearing_after":123,"bearing_before":114,"location":[25.687542,53.315927]},"name":"","weight_typical":85.182,"duration_typical":84.845,"duration":84.845,"distance":864.396,"driving_side":"right","weight":85.182,"mode":"driving","ref":"Н299","geometry":"mtcudBk~y~o@pOgi@rJeZzP_i@zTie@vJoSzKaz@`IyiAnCq_@v@s[~AaVxC_mAfC{d@fH_v@fAsDzj@ciBjHoWrDsMAqEk@uE"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Continue for 1.5 miles.</prosody></amazon:effect></speak>","announcement":"Continue for 1.5 miles.","distanceAlongGeometry":2114.538},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a half mile, Turn right onto <say-as interpret-as=\"address\">Н279</say-as>.</prosody></amazon:effect></speak>","announcement":"In a half mile, Turn right onto Н279.","distanceAlongGeometry":804.672},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Turn right onto <say-as interpret-as=\"address\">Н279</say-as>.</prosody></amazon:effect></speak>","announcement":"Turn right onto Н279.","distanceAlongGeometry":140}],"intersections":[{"entry":[true,false,true],"in":1,"bearings":[144,260,346],"duration":7.053,"turn_weight":18.75,"turn_duration":5.832,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":2,"weight":19.819,"geometry_index":63,"location":[25.699116,53.312889]},{"entry":[true,false,false],"in":2,"bearings":[5,93,166],"duration":12.562,"turn_duration":0.026,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":0,"weight":10.969,"geometry_index":64,"location":[25.699048,53.313057]},{"entry":[true,false],"in":1,"bearings":[6,186],"duration":16.714,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":0,"weight":14.625,"geometry_index":66,"location":[25.699328,53.314801]},{"entry":[true,false,false],"in":2,"bearings":[5,89,186],"duration":0.167,"turn_duration":0.007,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":0,"weight":0.14,"geometry_index":68,"location":[25.699755,53.317122]},{"entry":[true,false],"in":1,"bearings":[6,185],"duration":2.792,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":0,"weight":2.443,"geometry_index":69,"location":[25.69976,53.317156]},{"entry":[true,false],"in":1,"bearings":[6,186],"duration":24.611,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":0,"weight":21.535,"geometry_index":70,"location":[25.699817,53.317492]},{"entry":[true,false],"in":1,"bearings":[2,186],"duration":10.865,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":0,"weight":9.507,"geometry_index":73,"railway_crossing":true,"location":[25.700377,53.32085]},{"entry":[true,false,true],"in":1,"bearings":[46,149,320],"duration":29.817,"turn_duration":0.036,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":2,"weight":26.059,"geometry_index":79,"location":[25.699936,53.322289]},{"bearings":[10,109,288],"entry":[true,false,true],"in":1,"turn_duration":0.007,"mapbox_streets_v8":{"class":"primary"},"is_urban":false,"admin_index":0,"out":2,"geometry_index":87,"location":[25.693913,53.324071]}],"maneuver":{"type":"turn","instruction":"Turn left onto Р108.","modifier":"left","bearing_after":346,"bearing_before":80,"location":[25.699116,53.312889]},"name":"","weight_typical":140.72,"duration_typical":145.302,"duration":145.302,"distance":2134.538,"driving_side":"right","weight":140.72,"mode":"driving","ref":"Р108","geometry":"qv}tdBwqp_p@oIfCmHg@qbBgO_{@wIatA}NcAI_TqB{vBiSol@oFok@eFqWu@sPTaLrBiLfEuJvGuH|HmLpQaNhWoK`[cIpZqHz`@yJzp@y[znCaIhq@cn@rpF{m@fhFcJjv@}CtW"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Continue for 3 miles.</prosody></amazon:effect></speak>","announcement":"Continue for 3 miles.","distanceAlongGeometry":4532.318},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Turn left to stay on <say-as interpret-as=\"address\">Н279</say-as>.</prosody></amazon:effect></speak>","announcement":"In a quarter mile, Turn left to stay on Н279.","distanceAlongGeometry":402.336},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Turn left to stay on <say-as interpret-as=\"address\">Н279</say-as>.</prosody></amazon:effect></speak>","announcement":"Turn left to stay on Н279.","distanceAlongGeometry":88.889}],"intersections":[{"entry":[true,false,true],"in":1,"bearings":[16,109,289],"duration":85.838,"turn_weight":7,"turn_duration":1.814,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":80.521,"geometry_index":91,"location":[25.685034,53.325832]},{"entry":[true,false,true],"in":1,"bearings":[18,200,275],"duration":13.341,"turn_weight":0.75,"turn_duration":0.021,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":12.405,"geometry_index":99,"location":[25.690745,53.335744]},{"entry":[true,true,false],"in":2,"bearings":[7,90,191],"duration":58.776,"turn_weight":0.75,"turn_duration":0.024,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":52.158,"geometry_index":102,"location":[25.691433,53.337353]},{"entry":[true,true,false],"in":2,"bearings":[2,92,186],"duration":91.875,"turn_weight":0.75,"turn_duration":0.026,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":81.118,"geometry_index":109,"location":[25.692426,53.344654]},{"entry":[true,true,false],"in":2,"bearings":[6,99,183],"duration":9.544,"turn_weight":0.75,"turn_duration":0.008,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":9.093,"geometry_index":116,"location":[25.693276,53.353113]},{"entry":[true,false,true],"in":1,"bearings":[13,192,255],"duration":3.705,"turn_weight":0.75,"turn_duration":0.008,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":3.985,"geometry_index":119,"location":[25.693488,53.353984]},{"entry":[true,true,false],"in":2,"bearings":[9,25,193],"duration":15.204,"turn_weight":0.75,"turn_duration":0.026,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":14.031,"geometry_index":120,"location":[25.693613,53.354315]},{"entry":[true,true,false],"in":2,"bearings":[9,99,189],"duration":40.008,"turn_weight":0.75,"turn_duration":0.019,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":35.741,"geometry_index":121,"location":[25.693983,53.355703]},{"entry":[true,true,false,true],"in":2,"bearings":[23,89,195,267],"duration":28.325,"turn_weight":1.5,"turn_duration":0.011,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":26.274,"geometry_index":123,"location":[25.695007,53.359339]},{"entry":[true,false,true],"in":1,"bearings":[23,203,286],"duration":25.888,"turn_weight":0.75,"turn_duration":0.007,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":23.396,"geometry_index":125,"location":[25.696736,53.361743]},{"entry":[true,false,true],"in":1,"bearings":[51,206,344],"duration":1.01,"turn_weight":1.125,"turn_duration":0.037,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":1.976,"geometry_index":127,"location":[25.698325,53.363937]},{"entry":[true,true,false],"in":2,"bearings":[3,74,231],"duration":4.413,"turn_weight":1.125,"turn_duration":0.035,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":4.956,"geometry_index":128,"location":[25.698444,53.363995]},{"bearings":[1,91,270],"entry":[true,true,false],"in":2,"turn_weight":0.75,"turn_duration":0.008,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"geometry_index":131,"location":[25.6991,53.364049]}],"maneuver":{"type":"turn","instruction":"Turn right onto Н279.","modifier":"right","bearing_after":16,"bearing_before":289,"location":[25.685034,53.325832]},"name":"","weight_typical":356.791,"duration_typical":389.805,"duration":389.805,"distance":4548.984,"driving_side":"right","weight":356.791,"mode":"driving","ref":"Н279","geometry":"o_wudBsau~o@mI{Cio@oUcmDcbB{sC}wA{y@qe@oyAcq@sm@uZwh@cXmE{BmhAi_@uSyE{j@iHmt@mHirBkMovBmIyhAiIoReB{]_Di|AaDm}A}Kwx@qGw}@cGg{BkIwu@cCmh@}B_\\cD_OqCmHqBuSyFwuAcVqqEuw@uOiFqj@m^uiBskAm_Ce{AuGcFsBmFyA_HSmL@qQVcrB"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Continue for 2 miles.</prosody></amazon:effect></speak>","announcement":"Continue for 2 miles.","distanceAlongGeometry":3245.814},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Enter the roundabout and take the 3rd exit onto <say-as interpret-as=\"address\">Н300</say-as>.</prosody></amazon:effect></speak>","announcement":"In a quarter mile, Enter the roundabout and take the 3rd exit onto Н300.","distanceAlongGeometry":402.336},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Enter the roundabout and take the 3rd exit onto <say-as interpret-as=\"address\">Н300</say-as>.</prosody></amazon:effect></speak>","announcement":"Enter the roundabout and take the 3rd exit onto Н300.","distanceAlongGeometry":55.556}],"intersections":[{"entry":[true,true,true,false],"in":3,"bearings":[2,75,191,271],"duration":22.594,"turn_weight":5005,"turn_duration":5.275,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":6752.912,"geometry_index":132,"location":[25.700942,53.364037]},{"entry":[true,true,true,false,true],"in":3,"bearings":[0,82,103,182,251],"duration":7.026,"turn_weight":1.5,"turn_duration":0.021,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":708.521,"geometry_index":133,"location":[25.701028,53.365634]},{"entry":[true,true,false],"in":2,"bearings":[5,92,181],"duration":8.279,"turn_weight":0.75,"turn_duration":0.009,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":835.427,"geometry_index":135,"location":[25.701039,53.366284]},{"entry":[true,true,false],"in":2,"bearings":[1,23,189],"duration":6.147,"turn_weight":1.125,"turn_duration":0.018,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":1,"weight":619.768,"geometry_index":138,"location":[25.701192,53.367043]},{"entry":[true,false,true],"in":1,"bearings":[34,211,284],"duration":22.192,"turn_weight":0.75,"turn_duration":0.008,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":2239.648,"geometry_index":140,"location":[25.701614,53.367545]},{"entry":[true,true,false],"in":2,"bearings":[66,170,246],"duration":3.218,"turn_weight":0.75,"turn_duration":0.007,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":324.801,"geometry_index":144,"location":[25.704447,53.368645]},{"entry":[true,false,true],"in":1,"bearings":[67,246,344],"duration":189.835,"turn_weight":0.75,"turn_duration":0.008,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":19159.045,"geometry_index":145,"location":[25.7049,53.368768]},{"entry":[true,false,true],"in":1,"bearings":[68,248,289],"duration":9.153,"turn_weight":0.75,"turn_duration":0.007,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"weight":923.805,"geometry_index":150,"location":[25.732033,53.375495]},{"bearings":[64,173,248],"entry":[true,true,false],"in":2,"turn_weight":0.75,"turn_duration":0.026,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"geometry_index":151,"location":[25.733344,53.375808]}],"maneuver":{"type":"continue","instruction":"Turn left to stay on Н279.","modifier":"left","bearing_after":2,"bearing_before":91,"location":[25.700942,53.364037]},"name":"","weight_typical":36955.708,"duration_typical":321.887,"duration":321.887,"distance":3254.148,"driving_side":"right","weight":36955.708,"mode":"driving","ref":"Н279","geometry":"isaxdB{ct_p@ybBkDeVCmPQ{UcBkHmAeN_CcQaLgLiLqGuGsU{g@aIgYoZgdBuFi[u^o}B_^kuBunEseYglCq~PyGwc@qR}pAm`@urB_l@uyBml@onBu`@gyAi@}@"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Exit the roundabout onto <say-as interpret-as=\"address\">Н300</say-as>.</prosody></amazon:effect></speak>","announcement":"Exit the roundabout onto Н300.","distanceAlongGeometry":41.667}],"intersections":[{"entry":[true,false,false],"in":1,"bearings":[92,236,320],"duration":2.504,"turn_weight":6.125,"turn_duration":0.072,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":false,"admin_index":0,"out":0,"weight":8.254,"geometry_index":156,"location":[25.740417,53.37835]},{"entry":[true,true,false],"in":2,"bearings":[15,122,262],"duration":5.562,"turn_duration":2.254,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":false,"admin_index":0,"out":0,"weight":2.895,"geometry_index":160,"location":[25.740761,53.37836]},{"entry":[true,false,true],"in":1,"bearings":[46,153,293],"duration":0.863,"turn_duration":0.376,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":false,"admin_index":0,"out":2,"weight":0.426,"geometry_index":166,"location":[25.740715,53.378624]},{"bearings":[113,250],"entry":[false,true],"in":0,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":false,"admin_index":0,"out":1,"geometry_index":167,"location":[25.740644,53.378642]}],"maneuver":{"type":"roundabout","exit":3,"instruction":"Enter the roundabout and take the 3rd exit onto Н300.","modifier":"slight right","bearing_after":92,"bearing_before":56,"location":[25.740417,53.37835]},"name":"","weight_typical":13.703,"duration_typical":11.362,"duration":11.362,"distance":89.503,"driving_side":"right","weight":13.703,"mode":"driving","ref":"Н300","geometry":"{q}xdBagabp@p@gDJuDWuDy@{CoAmB_B}@eBGcBj@uA|A_AdCc@lCGvCNvCf@fC|@pBlAnA"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Continue for a half mile.</prosody></amazon:effect></speak>","announcement":"Continue for a half mile.","distanceAlongGeometry":944.217},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Turn left.</prosody></amazon:effect></speak>","announcement":"In a quarter mile, Turn left.","distanceAlongGeometry":402.336},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Turn left.</prosody></amazon:effect></speak>","announcement":"Turn left.","distanceAlongGeometry":66.667}],"intersections":[{"entry":[false,true,true],"in":0,"bearings":[57,177,335],"duration":56.736,"turn_weight":1.5,"turn_duration":3.125,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":2,"weight":47.07,"geometry_index":172,"location":[25.740327,53.378548]},{"entry":[false,true,true],"in":0,"bearings":[164,258,345],"duration":26.765,"turn_weight":0.75,"turn_duration":0.008,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":2,"weight":23.492,"geometry_index":179,"location":[25.738148,53.383318]},{"bearings":[27,130,212],"entry":[true,true,false],"in":2,"turn_weight":0.75,"turn_duration":0.028,"mapbox_streets_v8":{"class":"tertiary"},"is_urban":false,"admin_index":0,"out":0,"geometry_index":187,"location":[25.738488,53.385619]}],"maneuver":{"type":"exit roundabout","instruction":"Exit the roundabout onto Н300.","modifier":"right","bearing_after":335,"bearing_before":237,"location":[25.740327,53.378548]},"name":"","weight_typical":82.395,"duration_typical":96.567,"duration":96.567,"distance":960.884,"driving_side":"right","weight":82.395,"mode":"driving","ref":"Н300","geometry":"g~}xdBmaabp@y@lBs@t@ky@dWy_Al\\_x@`XgbAx\\gn@pU}x@dXoOtEcFJqGq@uFsDiJaIgViWmJ}J_]yXoZ_SeIiH"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In 1,000 feet, You will arrive at your destination.</prosody></amazon:effect></speak>","announcement":"In 1,000 feet, You will arrive at your destination.","distanceAlongGeometry":292.199},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">You have arrived at your destination.</prosody></amazon:effect></speak>","announcement":"You have arrived at your destination.","distanceAlongGeometry":48.611}],"intersections":[{"bearings":[48,209,291],"entry":[true,false,true],"in":1,"turn_weight":10,"turn_duration":6.114,"mapbox_streets_v8":{"class":"street"},"is_urban":false,"admin_index":0,"out":2,"geometry_index":190,"location":[25.73937,53.386702]}],"maneuver":{"type":"turn","instruction":"Turn left.","modifier":"left","bearing_after":291,"bearing_before":29,"location":[25.73937,53.386702]},"name":"","weight_typical":36.578,"duration_typical":37.383,"duration":37.383,"distance":303.866,"driving_side":"right","weight":36.578,"mode":"driving","geometry":"{{mydBse_bp@yg@btDaMjxA"},{"voiceInstructions":[],"intersections":[{"bearings":[105],"entry":[true],"in":0,"admin_index":0,"geometry_index":192,"location":[25.735042,53.38758]}],"maneuver":{"type":"arrive","instruction":"You have arrived at your destination.","bearing_after":0,"bearing_before":285,"location":[25.735042,53.38758]},"name":"","weight_typical":0,"duration_typical":0,"duration":0,"distance":0,"driving_side":"right","weight":0,"mode":"driving","geometry":"wroydBcwvap@??"}],"distance":15344.898,"summary":"Н299, Н279"}],"geometry":"usotdB{av|o@uU~k@_QvNm\\kCy[aMym@{Zac@wE{k@aQ{a@eWaEwCyxAueA{R_BjKogEsb@}k@uf@mPeRmPaU{i@kCe]~He_@xKsl@XmmAaSklFg@m^qFe|DXad@jAwlBkHuqA{AqX}MybCgFagDoBiy@aG_YuQ_^oUqRsb@s_@sTq[yLe_@mIae@_K{s@oC{b@jB_o@dIiq@tFec@bDiW~DaVpOgi@rJeZzP_i@zTie@vJoSzKaz@`IyiAnCq_@v@s[~AaVxC_mAfC{d@fH_v@fAsDzj@ciBjHoWrDsMAqEk@uEoIfCmHg@qbBgO_{@wIatA}NcAI_TqB{vBiSol@oFok@eFqWu@sPTaLrBiLfEuJvGuH|HmLpQaNhWoK`[cIpZqHz`@yJzp@y[znCaIhq@cn@rpF{m@fhFcJjv@}CtWmI{Cio@oUcmDcbB{sC}wA{y@qe@oyAcq@sm@uZwh@cXmE{BmhAi_@uSyE{j@iHmt@mHirBkMovBmIyhAiIoReB{]_Di|AaDm}A}Kwx@qGw}@cGg{BkIwu@cCmh@}B_\\cD_OqCmHqBuSyFwuAcVqqEuw@uOiFqj@m^uiBskAm_Ce{AuGcFsBmFyA_HSmL@qQVcrBybBkDeVCmPQ{UcBkHmAeN_CcQaLgLiLqGuGsU{g@aIgYoZgdBuFi[u^o}B_^kuBunEseYglCq~PyGwc@qR}pAm`@urB_l@uyBml@onBu`@gyAi@}@p@gDJuDWuDy@{CoAmB_B}@eBGcBj@uA|A_AdCc@lCGvCNvCf@fC|@pBlAnAy@lBs@t@ky@dWy_Al\\_x@`XgbAx\\gn@pU}x@dXoOtEcFJqGq@uFsDiJaIgViWmJ}J_]yXoZ_SeIiHyg@btDaMjxA","voiceLocale":"en-US"}],"waypoints":[{"distance":1630.153,"name":"","location":[25.652782,53.305675]},{"distance":1805.131,"name":"","location":[25.735042,53.38758]}],"code":"Ok","uuid":"hhXx70DgV-w6QK6ELhIdL9mscmvpGYCx8RpOB4J5vTNvh4q_45boRA=="}"""),
        RouteOptions.builder()
            .applyDefaultNavigationOptions()
            .coordinates("25.640055427475716,53.29316124149793;25.719421425635744,53.40085353151261")
            .excludeList(listOf(DirectionsCriteria.EXCLUDE_UNPAVED))
            .build(),
        RouterOrigin.Custom()
    )

    /**
     * Bindings to the example layout.
     */
    private lateinit var binding: LayoutActivityRouteNotificationsBinding

    /**
     * Additional route line options are available through the [MapboxRouteLineOptions].
     */
    private val options: MapboxRouteLineOptions by lazy {
        MapboxRouteLineOptions.Builder(this)
            .displayViolatedSections(true)
            .build()
    }

    /**
     * This class is responsible for rendering route line related mutations generated by the [routeLineApi]
     */
    private val routeLineView by lazy {
        MapboxRouteLineView(options)
    }

    /**
     * Generates updates for the [routeLineView] with the geometries and properties of the routes that should be drawn on the map.
     */
    private val routeLineApi: MapboxRouteLineApi by lazy {
        MapboxRouteLineApi(options)
    }

    /**
     * The observer is triggered when the routes are updated.
     * The important part is `showNotifications` invocation.
     */
    private val routesObserver: RoutesObserver = RoutesObserver { routeUpdateResult ->
        lifecycleScope.launch {
            routeLineApi.setNavigationRoutes(
                newRoutes = routeUpdateResult.navigationRoutes,
                alternativeRoutesMetadata = mapboxNavigation.getAlternativeMetadataFor(
                    routeUpdateResult.navigationRoutes
                )
            ).apply {
                routeLineView.renderRouteDrawData(
                    binding.mapView.getMapboxMap().getStyle()!!,
                    this
                )
            }
        }
    }

    /**
     * Mapbox navigation instance.
     */
    private val mapboxNavigation: MapboxNavigation by requireMapboxNavigation(
        onResumedObserver = object : MapboxNavigationObserver {
            @SuppressLint("MissingPermission")
            override fun onAttached(mapboxNavigation: MapboxNavigation) {
                mapboxNavigation.registerRoutesObserver(routesObserver)
                mapboxNavigation.startTripSession()
            }

            override fun onDetached(mapboxNavigation: MapboxNavigation) {
                mapboxNavigation.unregisterRoutesObserver(routesObserver)
            }
        },
        onInitialize = this::initNavigation
    )

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = LayoutActivityRouteNotificationsBinding.inflate(layoutInflater)
        setContentView(binding.root)

        binding.mapView.getMapboxMap().loadStyleUri(NavigationStyles.NAVIGATION_DAY_STYLE) {
            binding.actionButton.visibility = View.VISIBLE
        }

        binding.actionButton.text = "Set Route"
        binding.actionButton.setOnClickListener {
            mapboxNavigation.setNavigationRoutes(routes)
            val routeOrigin = routes.first().waypoints!!.last().location()
            val cameraOptions = CameraOptions.Builder().center(routeOrigin).zoom(11.0).build()
            binding.mapView.getMapboxMap().setCamera(cameraOptions)
            binding.actionButton.visibility = View.GONE
        }
    }

    private fun initNavigation() {
        MapboxNavigationApp.setup(
            NavigationOptions.Builder(this)
                .accessToken(getString(R.string.mapbox_access_token))
                .build()
        )

        binding.mapView.location.apply {
            enabled = true
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        routeLineView.cancel()
        routeLineApi.cancel()
    }
}
